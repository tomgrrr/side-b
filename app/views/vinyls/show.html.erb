<%
  # Parse genres from the genre name which contains a JSON array string
  if @vinyl.genres.any?
    raw_genre_name = @vinyl.genres.first.name
    parsed_genres = JSON.parse(raw_genre_name) rescue [raw_genre_name]
  else
    parsed_genres = []
  end
%>

<div class="vinyl-show-v1">
  <div class="main-content">
    <div class="cover-section">
  <div class="cover-frame">
    <% if @vinyl.image.present? %>
      <%= image_tag @vinyl.image, alt: @vinyl.name, class: "cover-img" %>
    <% else %>
      <div class="cover-img default">ðŸŽµ</div>
    <% end %>
    <div class="vinyl-disc">
      <% if @vinyl.image.present? %>
        <%= image_tag @vinyl.image, class: "disc-label" %>
      <% end %>
    </div>
  </div>

  <!-- YouTube Player -->
  <% if @youtube_videos.present? %>
    <div class="youtube-player-container mt-4"
        data-controller="youtube-player"
        data-youtube-player-video-id-value="<%= @youtube_videos.first[:video_id] %>">
      <h3 class="mb-3">ðŸŽµ Listen to this album</h3>
      <div id="youtube-player" data-youtube-player-target="frame"></div>
      <div class="video-list mt-3" data-youtube-player-target="videoList">
        <% @youtube_videos.each_with_index do |video, index| %>
          <div class="video-item <%= 'active' if index == 0 %>"
              data-action="click->youtube-player#playVideo"
              data-video-id="<%= video[:video_id] %>">
            <img src="<%= video[:thumbnail] %>"
                alt="<%= video[:title] %>"
                class="video-thumbnail">
            <div class="video-info">
              <p class="video-title"><%= video[:title] %></p>
              <p class="video-channel"><%= video[:channel] %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>


    <div class="info-section">
      <div class="breadcrumb">
        <%= link_to "Collection", collection_users_path %> /
        <% if parsed_genres.any? %>
          <%= parsed_genres.first %> /
        <% end %>
        <%= @vinyl.name %>
      </div>

      <% if parsed_genres.any? %>
        <div class="genre-badges">
          <% parsed_genres.each do |genre| %>
            <span class="genre-badge"><%= genre %></span>
          <% end %>
        </div>
      <% end %>

      <h1 class="album-title"><%= @vinyl.name %></h1>
      <p class="artist-name"><%= @vinyl.artists.map(&:name).join(", ") %></p>

      <div class="meta-grid">
        <div class="meta-item">
          <div class="meta-value"><%= @vinyl.release_date || "N/A" %></div>
          <div class="meta-label">Year</div>
        </div>
        <div class="meta-item">
        <div class="meta-value"><%= @vinyl.price.present? ? number_to_currency(@vinyl.price, unit: "â‚¬", format: "%n %u") : "N/A" %></div>

          <div class="meta-label">Price</div>
        </div>
        <div class="meta-item">
          <div class="meta-value"><%= parsed_genres.any? ? parsed_genres.join(", ") : "N/A" %></div>
          <div class="meta-label">Genre</div>
        </div>
      </div>

      <div class="action-buttons">
        <% if @in_collection %>
          <%= button_to "Remove from Collection", match_path(@collection_match), method: :delete, class: "btn-add", data: { confirm: "Are you sure?" } %>
          <div class="actions">
            <div class="dropdown playlist-dropdown">
              <button class="action-btn btn-playlist dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span>â™«</span> Add to a playlist
              </button>
              <ul class="dropdown-menu playlist-dropdown-menu">
                <li class="dropdown-header">Choose a playlist</li>
                <li><hr class="dropdown-divider"></li>
                <% @playlists.each do |playlist| %>
                  <li>
                    <%= link_to match_path(@collection, playlist_id: playlist.id), data: { turbo_method: :patch }, class: "dropdown-item" do %>
                      <span class="playlist-icon">ðŸŽµ</span>
                      <span class="playlist-name"><%= playlist.name %></span>
                      <span class="playlist-count"><%= @playlist_vinyl_counts[playlist.id] || 0 %></span>
                    <% end %>
                  </li>
                <% end %>
                <% if @playlists.empty? %>
                  <li><span class="dropdown-item disabled">No playlist yet</span></li>
                <% end %>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <%= link_to new_playlist_path, class: "dropdown-item create-playlist-item" do %>
                    <span class="playlist-icon">âž•</span>
                    <span class="playlist-name">Create new playlist</span>
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
        <% else %>
          <%= button_to matches_path(vinyl_id: @vinyl.id, category: "collection"), method: :post, class: "btn-add" do %>
            <span>+</span> Add to Collection
          <% end %>
        <% end %>

        <% if @in_wishlist %>
          <%= button_to match_path(@wishlist_match), method: :delete, class: "btn-wishlist active" do %>
          <i class="fas fa-heart"></i>
        <% end %>
        <% else %>
          <%= button_to matches_path(vinyl_id: @vinyl.id, category: "wishlist"), method: :post, class: "btn-wishlist" do %>
            <i class="far fa-heart"></i>
          <% end %>
        <% end %>
      </div>

      <% if @vinyl.songs.present? %>
        <div class="tracklist">
          <h3>Tracklist</h3>
          <% @vinyl.parsed_songs.each_with_index do |song, index| %>
            <div class="track">
              <span class="track-num"><%= (index + 1).to_s.rjust(2, '0') %></span>
              <span class="track-title"><%= song %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
